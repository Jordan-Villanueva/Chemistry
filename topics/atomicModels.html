<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Curso de Química - Modelos Atómicos</title>
  
  <style>
    /* ===============================
       VARIABLES Y BASE GLOBAL
    =============================== */
    :root { 
      --bg: #fafafa; 
      --card: #ffffff; 
      --accent: #2b7a78; 
      --muted: #666; 
      --light-accent: rgba(43, 122, 120, 0.1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0 auto;
      max-width: 1400px;
      padding: 16px;
      line-height: 1.5;
      color: #123;
      background: linear-gradient(#f7fbfb, #eef6f6);
    }

    .small { font-size: 0.85rem; color: var(--muted); }

    /* ===============================
       CABECERA
    =============================== */
    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .header h1 {
      flex: 1;
      min-width: 240px;
      margin: 0;
      font-size: 1.4rem;
      color: var(--accent);
    }

    /* ===============================
       LAYOUT PRINCIPAL
    =============================== */
    .layout {
      display: grid;
      grid-template-columns: 420px 1fr; 
      gap: 14px; 
      align-items: start;
    }

    .panel {
      background: var(--card);
      border-radius: 10px;
      padding: 14px; 
      box-shadow: 0 2px 6px rgba(10,10,10,0.06);
    }

    /* ===============================
       LISTA DE MODELOS
    =============================== */
    .models-list {
      display: flex;
      flex-direction: column; 
      gap: 10px;
    }

    .model-btn {
      display: block;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: white;
      cursor: pointer;
      text-align: left;
      font-size: 1rem;
      color: #123;
      transition: all 0.2s;
    }
    .model-btn:hover {
      border-color: var(--accent);
      background-color: var(--light-accent);
    }
    .model-btn.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(43,122,120,0.06);
      background-color: var(--light-accent);
    }

    /* ===============================
       ÁREA DE VISUALIZACIÓN
    =============================== */
    .vis-area {
      display: flex;
      flex-direction: column; 
      gap: 14px;
    }
    canvas {
      width: 100%; 
      background: linear-gradient(#fff,#fbffff); 
      border-radius: 6px; 
      display: block;
    }

    /* ===============================
       CONTROLES
    =============================== */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 12px;
      border-radius: 6px;
      border: 0;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn:hover { background: #1f5f5d; }

    .mutebtn {
      background: #ddd;
      color: #333;
    }
    .mutebtn:hover { background: #ccc; }

    /* ===============================
       EJERCICIOS
    =============================== */
    .exercise { margin-top: 12px; }
    .choices { display: flex; flex-direction: column; gap: 8px; }
    .choice {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }
    .choice:hover { border-color: var(--accent); }
    .choice.selected {
      border-color: var(--accent);
      background: #eef8f8;
    }

    /* ===============================
       VIDEO RESPONSIVO
    =============================== */
    .video-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%;
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-container iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: none;
    }

    /* ===============================
       MODO MÓVIL
    =============================== */
    @media (max-width: 900px){ 
      .layout { grid-template-columns: 1fr; }
      .header { text-align: center; justify-content: center; }
      .controls { justify-content: center; }
      .panel { padding: 16px; }
    }
  </style>
</head>

<body>
  <!-- ===============================
       CABECERA
  =============================== -->
  <div class="header">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='6' width='36' height='36' fill='%232b7a78'/><text x='50%' y='55%' font-size='18' fill='white' font-family='Arial' text-anchor='middle' alignment-baseline='middle'>A</text></svg>" alt="logo">
    <h1>Modelos Atómicos — Visual y ejercicios</h1>
    <div style="margin-left:auto" class="small">Interactividad: Dalton → Actual</div>
  </div>

  <!-- ===============================
       LAYOUT PRINCIPAL
  =============================== -->
  <div class="layout">
    <!-- COLUMNA IZQUIERDA -->
    <div class="panel">
      <h3>Selecciona modelo</h3>
      <div class="models-list" id="modelsList"></div>

      <div class="exercise">
        <label>Ejercicios / Preguntas</label>
        <div id="exerciseArea">
          <p class="small">Selecciona un modelo a la izquierda para ver ejercicios específicos.</p>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Actividad rápida: Emparejar experimento → modelo</label>
        <div class="choices" id="matchChoices"></div>
        <div style="margin-top:8px">
          <button class="btn" id="checkMatchBtn">Comprobar</button>
          <button class="btn mutebtn" id="resetMatch">Reiniciar</button>
        </div>
        <div id="matchFeedback" style="margin-top:8px"></div>
      </div>
      
      <footer>Autor: Jordan Ortiz · Maestro en Física</footer>
    </div>

    <!-- COLUMNA DERECHA -->
    <div class="panel vis-area">
      <div class="row" style="justify-content:space-between">
        <div>
          <strong id="modelTitle">Modelo: —</strong>
          <div class="small" id="modelYear">Año / autor</div>
        </div>
        <div class="controls">
          <button class="btn mutebtn" id="explainBtn">Mostrar explicación</button>
          <button class="btn" id="toggleAnim">Iniciar animación</button>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <canvas id="visCanvas" width="800" height="420"></canvas>
        </div>
        <div style="width:280px">
          <div class="panel" style="padding:8px">
            <strong>Información breve</strong>
            <p id="modelDesc" class="small">Selecciona un modelo para ver su descripción.</p>
            <hr>
            <strong>Conceptos clave</strong>
            <ul id="modelConcepts" class="small" style="padding-left:18px"></ul>
          </div>
        </div>
      </div>

      <div id="extraControls" style="margin-top:8px" class="small"></div>
    </div>
  </div>


  <script>
    /* Datos de modelos */
    const MODELS = [
      { id:'dalton', title:'John Dalton (Modelo Dalton)', year:'Principios del s. XIX', desc:'Átomos como partículas indivisibles y características de cada elemento. No explica cargas ni estructuras internas.', concepts:['Átomos indivisibles','Cada elemento tiene átomos iguales entre sí','Compuestos = combinación de átomos en proporciones'], exercise:{type:'mcq',question:'¿Cuál de las siguientes afirmaciones pertenece al modelo de Dalton?',options:['Los átomos son indivisibles y conservan sus propiedades al formar compuestos.','Los electrones están incrustados en una "sopa" positiva.','Los electrones ocupan orbitales difusos con probabilidades.'],answer:0,explanation:'Dalton planteó átomos como unidades indivisibles y que combinan en proporciones fijas para formar compuestos.'} },
      { id:'thomson', title:'J. J. Thomson (Modelo "Plum pudding")', year:'1897–1904', desc:'Descubrimiento del electrón; modelo con carga positiva difusa y electrones incrustados.', concepts:['Existencia de electrones','Carga positiva extendida','Electrones incrustados (como pasas)'], exercise:{type:'mcq',question:'¿Qué experimento llevó al descubrimiento del electrón y apoyó el modelo de Thomson?',options:['Descarga en tubos de rayos catódicos','Dispersión de partículas alfa','Espectros de líneas'],answer:0,explanation:'Los tubos de rayos catódicos mostraron partículas negativas (electrones).'} },
      { id:'rutherford', title:'Ernest Rutherford (Modelo nuclear)', year:'1911', desc:'Experimentos de la lámina de oro mostraron una región pequeña y densa (núcleo) con carga positiva. La mayor parte del átomo es espacio vacío.', concepts:['Núcleo pequeño, denso y positivo','Electrones alrededor en gran espacio vacío','Explica grandes ángulos de dispersión'], exercise:{type:'sim',question:'Simula partículas alfa disparadas contra un núcleo. ¿Qué observas cuando las partículas pasan cerca del núcleo?',options:[],answer:null,explanation:'Partículas que pasan cerca del núcleo se desvían fuertemente; las que pasan lejos continúan casi rectas.'} },
      { id:'bohr', title:'Niels Bohr (Modelo de Bohr)', year:'1913', desc:'Electrones en órbitas circulares cuantizadas. Explica las líneas espectrales del hidrógeno mediante transiciones entre niveles.', concepts:['Órbitas cuantizadas','Emisión/absorción por transiciones (ΔE = E2 - E1)','Explicación de espectro de H'], exercise:{type:'calc',question:'Calcula la energía (in eV) emitida cuando un electrón en H pasa de n=3 to n=2. (E_n = -13.6 eV / n^2)',options:[],answer:null,explanation:'Use E_n = -13.6/n^2. ΔE = E2 - E3 = (-13.6/2^2) - (-13.6/3^2) = ...'} },
      { id:'schrodinger', title:'Erwin Schrödinger (Modelo cuántico / mecánico ondulatorio)', year:'1926', desc:'Electrones descritos por funciones de onda; aparecen orbitales con probabilidades (números cuánticos).', concepts:['Función de onda ψ','Orbitales con densidad de probabilidad |ψ|^2','Explica estructuras más complejas'], exercise:{type:'mcq',question:'En el modelo de Schrödinger, ¿qué representa |ψ|^2?',options:['La densidad de probabilidad de encontrar el electrón en una región','La trayectoria exacta del electrón','La energía del núcleo'],answer:0,explanation:'|ψ|^2 es la densidad de probabilidad derivada de la función de onda ψ.'} },
      { id:'actual', title:'Modelo Actual (Orbitales y QED simplificado)', year:'Siglo XX–XXI', desc:'Combinación del modelo de orbitales cuánticos con efectos relativistas y correcciones de interacción campo-cuanto; se habla de orbitales, espín y principios de exclusión.', concepts:['Orbitales atómicos (mecánica cuántica)','Spin y estadísticas cuánticas','Correcciones: relativistas y QED'], exercise:{type:'mcq',question:'¿Qué concepto es parte del modelo atómico moderno?',options:['Orbitales con probabilidades','Átomos indivisibles sin estructura','Electrones incrustados en "sopa positiva"'],answer:0,explanation:'El modelo moderno utiliza orbitales cuánticos (densidades de probabilidad).'} }
    ];

    const modelsList = document.getElementById('modelsList');
    const modelTitle = document.getElementById('modelTitle');
    const modelYear = document.getElementById('modelYear');
    const modelDesc = document.getElementById('modelDesc');
    const modelConcepts = document.getElementById('modelConcepts');
    const exerciseArea = document.getElementById('exerciseArea');
    const visCanvas = document.getElementById('visCanvas');
    const ctx = visCanvas.getContext('2d');
    const toggleAnimBtn = document.getElementById('toggleAnim');
    const explainBtn = document.getElementById('explainBtn');
    const extraControls = document.getElementById('extraControls');

    const matchChoices = document.getElementById('matchChoices');
    const checkMatchBtn = document.getElementById('checkMatchBtn');
    const resetMatchBtn = document.getElementById('resetMatch');
    const matchFeedback = document.getElementById('matchFeedback');

    let currentModel = null;
    let animRunning = false;
    let animHandle = null;
    let rutherfordParticles = [];
    // parámetros ajustables para Rutherford
    let rutherfordParams = {
      K: 80000,      // fuerza efectiva (ajustable)
      speed: 3.0     // velocidad inicial
    };

    // Variables para la animación de Thomson
    let thomsonElectrons = [];
    let thomsonAnimationId = null;

    // Init UI
    function initModelsList(){
      MODELS.forEach(m=>{
        const btn = document.createElement('button');
        btn.className = 'model-btn';
        btn.innerHTML = `<strong>${m.title.split('(')[0].trim()}</strong><div class="small">${m.year}</div>`;
        btn.onclick = ()=> selectModel(m.id, btn);
        modelsList.appendChild(btn);
        m._btn = btn;
      });
    }

    function selectModel(id, btnRef){
      // Detener cualquier animación en curso
      stopAllAnimations();
      
      MODELS.forEach(m=>{ if(m._btn) m._btn.classList.remove('active'); });
      if(btnRef) btnRef.classList.add('active');
      const m = MODELS.find(x=>x.id===id);
      currentModel = m;
      modelTitle.textContent = `Modelo: ${m.title}`;
      modelYear.textContent = m.year;
      modelDesc.textContent = m.desc;
      modelConcepts.innerHTML = '';
      m.concepts.forEach(c=>{ const li=document.createElement('li'); li.textContent=c; modelConcepts.appendChild(li); });
      renderExercise(m);
      drawModel(m.id);
      extraControls.innerHTML = '';
      
      // Actualizar estado del botón de animación
      animRunning = false;
      toggleAnimBtn.textContent = 'Iniciar animación';
      
      if(m.id === 'thomson'){
        const videoDiv = document.createElement('div');
        videoDiv.style.marginTop = '12px';
        videoDiv.innerHTML = `
          <strong>Demostración de rayos catódicos</strong>
          <p class="small">Observa cómo las partículas (electrones) se mueven dentro del tubo de Crookes vacío.</p>
          <div class="video-container">
            <iframe src="https://www.youtube.com/embed/7YHwMWcXfLE" title="Rayos catódicos" allowfullscreen></iframe>
          </div>
        `;
        extraControls.appendChild(videoDiv);
        
        // Inicializar electrones para la animación de Thomson
        initThomsonElectrons();
      }
      
      if(m.id === 'rutherford'){
        const ctrl = document.createElement('div');
        ctrl.innerHTML = `
          <div class="small">Ajusta parámetros para ver distintos regímenes de dispersión:</div>
          <div class="control-row small" style="margin-top:8px">
            <div style="min-width:88px">Fuerza (K):</div>
            <input id="r_k" type="range" min="1000" max="200000" value="${rutherfordParams.K}" />
            <div id="kVal" class="small" style="min-width:60px;text-align:right">${rutherfordParams.K}</div>
          </div>
          <div class="control-row small" style="margin-top:6px">
            <div style="min-width:88px">Velocidad:</div>
            <input id="r_speed" type="range" min="1" max="8" step="0.1" value="${rutherfordParams.speed}" />
            <div id="speedVal" class="small" style="min-width:60px;text-align:right">${rutherfordParams.speed}</div>
          </div>
          <div class="small" style="margin-top:8px">Pulsa <strong>Iniciar animación</strong> para lanzar partículas alfa contra el núcleo. Observa cómo las que pasan cerca se desvían fuertemente.</div>
          <div style="margin-top:12px">
            <strong>Video del experimento de Rutherford</strong>
            <div class="video-container">
              <iframe src="https://www.youtube.com/embed/XBqHkraf8iE" title="Experimento de Rutherford" allowfullscreen></iframe>
            </div>
          </div>
          <div class="small" style="margin-top:10px">
            Nota: Rutherford utilizó partículas alfa, emitidas por materiales radiactivos, para estudiar la dispersión en la lámina de oro. Esto permitió deducir la existencia del núcleo y el predominio de espacio vacío en el átomo.
          </div>
        `;
        extraControls.appendChild(ctrl);

        // attach events a sliders
        const kSlider = document.getElementById('r_k');
        const kVal = document.getElementById('kVal');
        kSlider.oninput = ()=> { rutherfordParams.K = Number(kSlider.value); kVal.textContent = kSlider.value; };
        const speedSlider = document.getElementById('r_speed');
        const speedVal = document.getElementById('speedVal');
        speedSlider.oninput = ()=> { rutherfordParams.speed = Number(speedSlider.value); speedVal.textContent = rutherfordParams.speed; };
        
        // Inicializar partículas para Rutherford
        setupRutherford();
      }

      if(m.id === 'bohr'){
        const input = document.createElement('div');
        input.innerHTML = `
          <label class="small">Transición: desde n=<input id="nFrom" type="number" min="1" value="3" style="width:60px"/> a n=<input id="nTo" type="number" min="1" value="2" style="width:60px"/></label>
          <div><button class="btn" id="calcBohr">Calcular ΔE (eV)</button><span id="bohrResult" class="small" style="margin-left:8px"></span></div>
        `;
        extraControls.appendChild(input);
        document.getElementById('calcBohr').onclick = ()=> calcBohr();
        
        const bohrDiv = document.createElement('div');
        bohrDiv.style.marginTop = '12px';
        bohrDiv.innerHTML = `
          <strong>Modelo de Bohr</strong>
          <p class="small">Observa cómo los electrones se mueven en órbitas discretas alrededor del núcleo y cómo emiten o absorben energía al cambiar de nivel.</p>

          <div style="margin-top:8px">
            <strong>Video: Transiciones electrónicas</strong>
            <div class="video-container">
              <iframe src="https://www.youtube.com/embed/GhAn8xZQ-d8" title="Modelo de Bohr" allowfullscreen></iframe>
            </div>
          </div>
        `;
        extraControls.appendChild(bohrDiv);
      }
    }

    function stopAllAnimations() {
      // Detener animación de Rutherford
      if (rutherfordAnimRAF) {
        cancelAnimationFrame(rutherfordAnimRAF);
        rutherfordAnimRAF = null;
      }
      
      // Detener animación de Thomson
      if (thomsonAnimationId) {
        cancelAnimationFrame(thomsonAnimationId);
        thomsonAnimationId = null;
      }
      
      // Detener otras animaciones
      if (animHandle) {
        clearInterval(animHandle);
        animHandle = null;
      }
      
      animRunning = false;
    }

    function initThomsonElectrons() {
      thomsonElectrons = [];
      const w = visCanvas.width, h = visCanvas.height;
      const centerX = w/2, centerY = h/2;
      
      for(let i=0; i<15; i++){
        const ang = Math.random() * Math.PI * 2;
        const rad = 20 + Math.random() * 120;
        const speed = 0.5 + Math.random() * 1.5;
        
        thomsonElectrons.push({
          angle: ang,
          radius: rad,
          speed: speed,
          x: centerX + Math.cos(ang) * rad,
          y: centerY + Math.sin(ang) * rad
        });
      }
    }

    function animateThomson() {
      if (!animRunning || currentModel.id !== 'thomson') return;
      
      const w = visCanvas.width, h = visCanvas.height;
      const centerX = w/2, centerY = h/2;
      
      // Actualizar posiciones de electrones
      thomsonElectrons.forEach(electron => {
        electron.angle += 0.02 * electron.speed;
        electron.x = centerX + Math.cos(electron.angle) * electron.radius;
        electron.y = centerY + Math.sin(electron.angle) * electron.radius;
      });
      
      // Redibujar
      drawThomson();
      
      // Continuar animación
      thomsonAnimationId = requestAnimationFrame(animateThomson);
    }

    function renderExercise(m){
      exerciseArea.innerHTML = '';
      if(m.exercise.type === 'mcq'){
        const q = document.createElement('div');
        q.innerHTML = `<div><strong>${m.exercise.question}</strong></div>`;
        const choices = document.createElement('div'); 
        choices.className = 'choices';
        m.exercise.options.forEach((opt,i)=>{
          const ch = document.createElement('div'); 
          ch.className='choice'; 
          ch.textContent = opt;
          ch.onclick = ()=> { 
            Array.from(choices.children).forEach(c=>c.classList.remove('selected')); 
            ch.classList.add('selected'); 
          };
          choices.appendChild(ch);
        });
        q.appendChild(choices);
        const btn = document.createElement('div');
        btn.style.marginTop='8px';
        btn.innerHTML = `<button class="btn" id="checkBtn">Comprobar</button> <button class="btn mutebtn" id="resetBtn">Reiniciar</button> <div id="feedback"></div>`;
        q.appendChild(btn);
        exerciseArea.appendChild(q);
        document.getElementById('checkBtn').onclick = ()=>{
          const selected = Array.from(choices.children).findIndex(c=>c.classList.contains('selected'));
          const fb = document.getElementById('feedback');
          if(selected === -1){ fb.innerHTML = `<div class="feedback wrong">Selecciona una opción antes.</div>`; return; }
          if(selected === m.exercise.answer){
            fb.innerHTML = `<div class="feedback correct">Correcto ✓<br/><small>${m.exercise.explanation}</small></div>`;
          } else {
            fb.innerHTML = `<div class="feedback wrong">Incorrecto ✗<br/><small>${m.exercise.explanation}</small></div>`;
          }
        };
        document.getElementById('resetBtn').onclick = ()=> { 
          Array.from(choices.children).forEach(c=>c.classList.remove('selected')); 
          document.getElementById('feedback').innerHTML=''; 
        };
      } else if(m.exercise.type === 'sim'){
        exerciseArea.innerHTML = `<p class="small"><strong>${m.exercise.question}</strong><br/>Observa la animación en la derecha: ajusta fuerza/velocidad para estudiar la dispersión. Analiza y comenta en clase.</p>`;
      } else if(m.exercise.type === 'calc'){
        exerciseArea.innerHTML = `<p class="small"><strong>${m.exercise.question}</strong><br/>Pulsa el control de la derecha para calcular.</p>`;
      }
    }

    function calcBohr(){
      const nFrom = Number(document.getElementById('nFrom').value);
      const nTo = Number(document.getElementById('nTo').value);
      if(nFrom<1 || nTo<1){ document.getElementById('bohrResult').textContent = 'n debe ser >=1'; return; }
      const E = (n)=> -13.6 / (n*n);
      const dE = E(nTo) - E(nFrom);
      const emitted = dE < 0 ? true : false;
      document.getElementById('bohrResult').textContent = `${dE.toFixed(3)} eV ${emitted ? '(emitido)' : '(absorbido)'}`;
    }

    // Matching activity
    const matchItems = [
      {exp:'Tubo de rayos catódicos', model:'thomson'},
      {exp:'Experimento de la lámina de oro (dispersión de partículas alfa)', model:'rutherford'},
      {exp:'Espectro de líneas del hidrógeno', model:'bohr'},
      {exp:'Comportamiento probabilístico de electrones (orbitales)', model:'schrodinger'}
    ];
    
    function initMatch(){
      matchChoices.innerHTML = '';
      matchItems.forEach((it,idx)=>{
        const row = document.createElement('div'); 
        row.style.display='flex';
        row.style.gap='8px';
        row.style.alignItems='center';
        row.innerHTML = `<div style="flex:1;padding:8px;border-radius:6px;border:1px solid #eee">${it.exp}</div>`;
        const sel = document.createElement('select'); 
        sel.style.width='160px';
        const opt0 = document.createElement('option'); 
        opt0.value=''; 
        opt0.textContent='—Seleccionar—'; 
        sel.appendChild(opt0);
        MODELS.forEach(m=>{ 
          const o=document.createElement('option'); 
          o.value=m.id; 
          o.textContent = m.title.split('(')[0].trim(); 
          sel.appendChild(o); 
        });
        sel.dataset.correct = it.model;
        row.appendChild(sel);
        matchChoices.appendChild(row);
      });
    }

    checkMatchBtn.onclick = ()=>{
      const selects = matchChoices.querySelectorAll('select');
      let correctCount = 0;
      selects.forEach(s=>{
        const got = s.value; 
        const want = s.dataset.correct;
        s.style.border = '1px solid #ddd';
        if(got === want) { 
          correctCount++; 
          s.style.border = '2px solid #8ad6a1'; 
        } else { 
          s.style.border = '2px solid #f0a3a3'; 
        }
      });
      matchFeedback.innerHTML = `<div class="${correctCount===selects.length?'correct':'wrong'} feedback">${correctCount} de ${selects.length} correctas.</div>`;
    };
    
    resetMatchBtn.onclick = ()=> { initMatch(); matchFeedback.innerHTML=''; };

    // ----------------
    // VISUALIZACIONES
    // ----------------
    function clearCanvas(){ ctx.clearRect(0,0,visCanvas.width,visCanvas.height); }

    // Dalton
    function drawDalton(){
      clearCanvas();
      const w=visCanvas.width, h=visCanvas.height;
      ctx.fillStyle='#2b7a78';
      const r=22; 
      const cols=6, rows=4; 
      const startX = 80, startY=60;
      for(let i=0;i<rows;i++){
        for(let j=0;j<cols;j++){
          const x = startX + j*60 + (i%2?30:0);
          const y = startY + i*60;
          ctx.beginPath(); 
          ctx.arc(x,y,r,0,Math.PI*2); 
          ctx.fill();
          ctx.fillStyle='#ffffff'; 
          ctx.font='14px monospace'; 
          ctx.textAlign='center'; 
          ctx.textBaseline='middle'; 
          ctx.fillText('A', x, y);
          ctx.fillStyle='#2b7a78';
        }
      }
      ctx.fillStyle='#123'; 
      ctx.font='16px sans-serif'; 
      ctx.textAlign='left'; 
      ctx.fillText('Átomos indivisibles (Dalton)', 10, visCanvas.height-20);
    }

    // Thomson
    function drawThomson(){
      clearCanvas();
      const w=visCanvas.width, h=visCanvas.height; 
      const centerX = w/2, centerY = h/2;
      const grad = ctx.createRadialGradient(centerX, centerY, 20, centerX, centerY, 140);
      grad.addColorStop(0, '#ffdede'); 
      grad.addColorStop(1, '#ffe');
      ctx.beginPath(); 
      ctx.arc(centerX, centerY, 140, 0, Math.PI*2); 
      ctx.fillStyle=grad; 
      ctx.fill(); 
      ctx.strokeStyle='#f0bcbc'; 
      ctx.stroke();
      
      // Dibujar electrones
      ctx.fillStyle='#2b7a78';
      thomsonElectrons.forEach(electron => {
        ctx.beginPath(); 
        ctx.arc(electron.x, electron.y, 8, 0, Math.PI*2); 
        ctx.fill();
      });
      
      ctx.fillStyle='#123'; 
      ctx.font='16px sans-serif'; 
      ctx.fillText('Electrones incrustados (Thomson)', 10, 30);
    }

    // ------- RUTHERFORD (MEJORADA) -------
    function setupRutherford(){
      rutherfordParticles = [];
      const w=visCanvas.width, h=visCanvas.height;
      const sourceX = 40;
      const n = 28;
      for(let i=0;i<n;i++){
        const y = h*0.18 + i*(h*0.64)/n;
        const spread = (Math.random()-0.5)*0.4;
        const vx = rutherfordParams.speed + (Math.random()*0.6-0.3);
        const vy = spread;
        rutherfordParticles.push({
          x0: sourceX, y0: y, x: sourceX, y: y,
          vx: vx, vy: vy,
          active: true,
          trail: [{x: sourceX, y: y}],
          color: '#2b7a78'
        });
      }
    }

    // Step physics: stronger, softened Coulomb-like repulsion and visible trails
    function stepRutherford(){
      const w=visCanvas.width, h=visCanvas.height;
      const nucleusX = w*0.62, nucleusY = h/2, nucleusR = 18;
      const K = rutherfordParams.K; // fuerza efectiva ajustable
      for(let p of rutherfordParticles){
        if(!p.active) continue;
        // compute vector nucleus -> particle
        const dx = p.x - nucleusX;
        const dy = p.y - nucleusY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const minDist = 8; // softening term to avoid infinite forces
        // apply repulsive acceleration (directed away from nucleus)
        // F ~ K / (r^2 + eps)
        const soft = Math.max(dist, minDist);
        const force = K / (soft*soft + 10); // added small +10 to moderate extremely close values
        // scale factor chosen by experiment to produce visible deflections
        const scale = 0.0009;
        const ax = (dx/soft) * force * scale;
        const ay = (dy/soft) * force * scale;
        // update velocity & position
        p.vx += ax;
        p.vy += ay;
        p.x += p.vx;
        p.y += p.vy;
        // record trail (short)
        p.trail.push({x: p.x, y: p.y});
        if(p.trail.length > 100) p.trail.shift();
        // mark inactive if out of bounds
        if(p.x > w + 40 || p.y < -80 || p.y > h+80) p.active = false;
        // if particle gets extremely close (within nucleus radius) mark and remove (absorbed/backscattered)
        if(dist < nucleusR + 2){
          // big kick to simulate strong deflection or absorption; flip vx to simulate backscatter
          p.vx = -p.vx * 0.6;
          p.vy = -p.vy * 0.6;
          // give a different color for strongly deflected/backscattered
          p.color = '#d9534f';
        }
      }
    }

    function drawRutherford(){
      clearCanvas();
      const w=visCanvas.width, h=visCanvas.height;
      const nucleusX = w*0.62, nucleusY = h/2, nucleusR = 18;
      // draw nucleus
      ctx.beginPath(); 
      ctx.arc(nucleusX, nucleusY, nucleusR, 0, Math.PI*2); 
      ctx.fillStyle='#d9534f'; 
      ctx.fill();
      ctx.fillStyle='#123'; 
      ctx.font='14px sans-serif'; 
      ctx.fillText('Núcleo', nucleusX+26, nucleusY+6);
      // draw thin target plane
      ctx.strokeStyle='#ccc'; 
      ctx.beginPath(); 
      ctx.moveTo(nucleusX-10,nucleusY-160); 
      ctx.lineTo(nucleusX-10,nucleusY+160); 
      ctx.stroke();
      // draw particles and trails
      for(let p of rutherfordParticles){
        // trail
        if(p.trail && p.trail.length>1){
          ctx.beginPath();
          ctx.moveTo(p.trail[0].x, p.trail[0].y);
          for(let i=1;i<p.trail.length;i++){
            ctx.lineTo(p.trail[i].x, p.trail[i].y);
          }
          // trail color fades
          ctx.strokeStyle = p.color==='#d9534f' ? 'rgba(217,83,79,0.6)' : 'rgba(43,122,120,0.85)';
          ctx.lineWidth = 1.6; 
          ctx.stroke();
        }
        // particle dot
        ctx.beginPath(); 
        ctx.arc(p.x, p.y, 4.2, 0, Math.PI*2); 
        ctx.fillStyle = p.color; 
        ctx.fill();
      }
      ctx.fillStyle='#123'; 
      ctx.font='14px sans-serif'; 
      ctx.fillText('Partículas alfa →', 10, 30);
      ctx.font='12px monospace'; 
      ctx.fillText('Ajusta Fuerza (K) y Velocidad para ver distintos ángulos de dispersión', 10, 48);
    }

    // Animation loop for Rutherford (using requestAnimationFrame, start/stop safe)
    let rutherfordAnimRAF = null;
    function animateRutherfordFrame(){
      stepRutherford();
      drawRutherford();
      // continue if any active particles
      const anyActive = rutherfordParticles.some(p=>p.active);
      if(anyActive && animRunning && currentModel.id === 'rutherford') {
        rutherfordAnimRAF = requestAnimationFrame(animateRutherfordFrame);
      } else { 
        rutherfordAnimRAF = null; 
        animRunning = false; 
        toggleAnimBtn.textContent = 'Iniciar animación'; 
      }
    }

    function drawBohr(state={n:3,showTransition:false,to:2}){
      clearCanvas();
      const w=visCanvas.width, h=visCanvas.height, cx=w/2, cy=h/2;

      // Núcleo
      ctx.beginPath(); 
      ctx.arc(cx,cy,12,0,Math.PI*2); 
      ctx.fillStyle='#d9534f'; 
      ctx.fill();

      // Órbitas
      for(let n=1;n<=5;n++){
        ctx.beginPath(); 
        ctx.arc(cx,cy,30*n,0,Math.PI*2);
        ctx.strokeStyle = '#e0f5f5'; 
        ctx.lineWidth=2; 
        ctx.stroke();
        ctx.fillStyle='#123'; 
        ctx.font='12px sans-serif'; 
        ctx.fillText('n='+n, cx+30*n+8, cy-4);
      }

      // Electrón en la órbita actual
      const theta = -0.6;
      const r = 30*state.n;
      ctx.beginPath(); 
      ctx.arc(cx+r*Math.cos(theta), cy+r*Math.sin(theta),6,0,Math.PI*2);
      ctx.fillStyle='#2b7a78'; 
      ctx.fill();

      // Transición (salto entre niveles)
      if(state.showTransition){
        const r1 = 30*state.n;
        const r2 = 30*state.to;
        const x1 = cx + r1*Math.cos(theta), y1 = cy + r1*Math.sin(theta);
        const x2 = cx + r2*Math.cos(theta), y2 = cy + r2*Math.sin(theta);
        ctx.beginPath(); 
        ctx.moveTo(x1,y1); 
        ctx.lineTo(x2,y2); 
        ctx.strokeStyle='#ff8a00'; 
        ctx.lineWidth=3; 
        ctx.stroke();
      }

      ctx.fillStyle='#123'; 
      ctx.font='16px sans-serif'; 
      ctx.fillText('Órbitas cuantizadas (Bohr)', 10, 30);
    }

    function drawSchrodinger(mode='1s'){
      clearCanvas();
      const w=visCanvas.width, h=visCanvas.height, cx = w/2, cy = h/2;

      // núcleo
      ctx.beginPath(); 
      ctx.arc(cx,cy,8,0,Math.PI*2); 
      ctx.fillStyle='#d9534f'; 
      ctx.fill();

      if(mode==='1s'){ // Esfera
        for(let r=10;r<140;r+=6){
          ctx.beginPath(); 
          ctx.arc(cx,cy,r,0,Math.PI*2);
          ctx.fillStyle = `rgba(43,122,120,${0.12*Math.exp(-r/40)})`; 
          ctx.fill();
        }
        ctx.fillStyle='#123'; 
        ctx.font='16px sans-serif'; 
        ctx.fillText('Orbital 1s', 10, 30);

      } else if(mode==='2p'){ // Dos lóbulos
        for(let i=0;i<80;i+=4){
          ctx.beginPath();
          ctx.ellipse(cx+40, cy, i/2+6, i/4+6, 0, 0, Math.PI*2);
          ctx.fillStyle = `rgba(43,122,120,${0.04*Math.exp(-i/40)})`; 
          ctx.fill();

          ctx.beginPath();
          ctx.ellipse(cx-40, cy, i/2+6, i/4+6, 0, 0, Math.PI*2);
          ctx.fillStyle = `rgba(43,122,120,${0.04*Math.exp(-i/40)})`; 
          ctx.fill();
        }
        ctx.fillStyle='#123'; 
        ctx.font='16px sans-serif'; 
        ctx.fillText('Orbital 2p', 10, 30);

      } else if(mode==='3d'){ // Cuatro lóbulos tipo trébol
        for(let i=0;i<60;i+=3){
          for(let ang=0; ang<Math.PI*2; ang+=Math.PI/2){
            const x = cx + Math.cos(ang)*50;
            const y = cy + Math.sin(ang)*50;
            ctx.beginPath();
            ctx.ellipse(x, y, i/2+6, i/4+6, ang, 0, Math.PI*2);
            ctx.fillStyle = `rgba(43,122,120,${0.05*Math.exp(-i/35)})`;
            ctx.fill();
          }
        }
        ctx.fillStyle='#123'; 
        ctx.font='16px sans-serif'; 
        ctx.fillText('Orbital 3d (trébol)', 10, 30);

      } else if(mode==='4f'){ // varios lóbulos (representación artística)
        for(let i=0;i<50;i+=3){
          for(let ang=0; ang<Math.PI*2; ang+=Math.PI/3){
            const x = cx + Math.cos(ang)*70;
            const y = cy + Math.sin(ang)*70;
            ctx.beginPath();
            ctx.ellipse(x, y, i/2+5, i/4+5, ang/2, 0, Math.PI*2);
            ctx.fillStyle = `rgba(43,122,120,${0.04*Math.exp(-i/30)})`;
            ctx.fill();
          }
        }
        ctx.fillStyle='#123'; 
        ctx.font='16px sans-serif'; 
        ctx.fillText('Orbital 4f (esquemático)', 10, 30);
      }
    }

    function drawActual(){
      clearCanvas();
      const w = visCanvas.width, h = visCanvas.height, cx = w/2, cy = h/2;

      // Núcleo
      ctx.beginPath();
      ctx.arc(cx, cy, 15, 0, Math.PI*2);
      ctx.fillStyle = '#d9534f';
      ctx.fill();

      // Nube electrónica (muchos puntitos semitransparentes)
      for(let i=0; i<600; i++){
        let r = 150 * Math.sqrt(Math.random()); // distribución radial más realista
        let theta = Math.random() * 2 * Math.PI;
        let x = cx + r * Math.cos(theta);
        let y = cy + r * Math.sin(theta);

        ctx.fillStyle = 'rgba(43, 122, 120, 0.2)'; // azul verdoso semitransparente
        ctx.fillRect(x, y, 2, 2);
      }

      ctx.fillStyle = '#123';
      ctx.font = '16px sans-serif';
      ctx.fillText('Modelo actual: nube electrónica', 10, 30);
    }

    function drawModel(id){
      // stop existing animations
      stopAllAnimations();
      
      if(id==='dalton') drawDalton();
      else if(id==='thomson') {
        initThomsonElectrons();
        drawThomson();
      }
      else if(id==='rutherford'){ setupRutherford(); drawRutherford(); }
      else if(id==='bohr') drawBohr({n:3, showTransition:false, to:2});
      else if(id==='schrodinger') drawSchrodinger('1s');
      else if(id==='actual') drawActual();
      
      // Actualizar estado del botón
      toggleAnimBtn.textContent = 'Iniciar animación';
      animRunning = false;
    }

    // Animation control (toggle)
    toggleAnimBtn.onclick = ()=> {
      if(!currentModel) return;
      
      if(animRunning){
        // Detener animación
        stopAllAnimations();
        toggleAnimBtn.textContent = 'Iniciar animación';
        animRunning = false;
      } else {
        // Iniciar animación
        animRunning = true;
        toggleAnimBtn.textContent = 'Detener animación';
        
        if(currentModel.id === 'rutherford'){
          setupRutherford();
          rutherfordAnimRAF = requestAnimationFrame(animateRutherfordFrame);
        } else if(currentModel.id === 'thomson') {
          animateThomson();
        } else if(currentModel.id === 'bohr'){
          let step = 0;
          animHandle = setInterval(()=>{
            if(step===0){
              drawBohr({n:3, showTransition:true, to:2}); // transición 3→2
            } else if(step===1){
              drawBohr({n:2, showTransition:false, to:2}); // electrón ya en n=2
            } else {
              drawBohr({n:3, showTransition:false, to:2}); // vuelve a n=3
              step = -1; // reinicia ciclo
            }
            step++;
          }, 900);
        } else if(currentModel.id === 'schrodinger'){
          let modes = ['1s','2p','3d','4f'];
          let idx = 0;
          animHandle = setInterval(()=>{
            drawSchrodinger(modes[idx]);
            idx = (idx+1) % modes.length;
          }, 1500);
        } else {
          animHandle = setInterval(()=>{ 
            if(currentModel.id==='thomson') drawThomson(); 
            else if(currentModel.id==='dalton') drawDalton(); 
            else if(currentModel.id==='actual') drawActual(); 
          }, 900);
        }
      }
    };

    // Explain button
    explainBtn.onclick = ()=> {
      if(!currentModel) return alert('Selecciona un modelo primero');
      alert(`Explicación: ${currentModel.title}\n\n${currentModel.desc}\n\nConceptos:\n- ${currentModel.concepts.join('\n- ')}`);
    };

    // clicking canvas toggles Bohr transition quick demo
    visCanvas.onclick = (e)=>{
      if(!currentModel) return;
      if(currentModel.id==='bohr'){
        drawBohr({n:3, showTransition:true, to:2});
        setTimeout(()=>drawBohr({n:3, showTransition:false, to:2}),900);
      }
    };

    // keyboard shortcut n = next model
    document.addEventListener('keydown',(e)=>{
      if(e.key === 'n' && currentModel){
        const idx = MODELS.findIndex(m=>m.id===currentModel.id);
        const next = MODELS[(idx+1)%MODELS.length];
        selectModel(next.id, next._btn);
      }
    });

    // initialize
    initModelsList();
    initMatch();
    selectModel('dalton', MODELS[0]._btn);
  </script>
</body>
</html>
